<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登录</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/css/bootstrap-icons.min.css" rel="stylesheet">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.bundle.min.js"></script>
  <script src="/js/htmx.min.js"></script>
</head>

<body>
  <div class="container">
    <h2 class="mt-5">登录</h2>
    <ul class="nav nav-tabs" id="loginTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="password-login-tab" data-bs-toggle="tab" href="#password-login" role="tab"
          aria-controls="password-login" aria-selected="true">密码登录</a>
      </li>
    </ul>
    <div class="tab-content" id="loginTabContent">
      <div class="tab-pane fade show active" id="password-login" role="tabpanel" aria-labelledby="password-login-tab">
        <div class="mt-3">
          <label for="username" class="form-label">用户名</label>
          <input type="text" class="form-control" id="username" name="username" required>
        </div>
        <div class="mt-3">
          <label for="password" class="form-label">密码</label>
          <input type="password" class="form-control" id="password" name="password" required>
        </div>
        <button id="passwordLoginButton" class="btn btn-primary mt-3" hx-post="/api/auth/login" hx-trigger="click"
          hx-include="#username,#password" hx-swap="none">登录</button>
      </div>
    </div>
    <div id="errorMessage" class="alert alert-danger d-none mt-3"></div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">提示</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
      </div>
    </div>
  </div>
  <script>
    //显示提示信息的函数
    function showToast(message) {
      // 设置提示框的文本内容
      $('#toastBody').text(message);
      // 创建 Bootstrap Toast 实例
      const toast = new bootstrap.Toast(document.getElementById('toastMessage'));
      // 显示提示框
      toast.show();
    }
    // 处理登录响应的函数
    function handleLoginResponse(event) {
      // 解析 AJAX 请求的响应内容
      const result = JSON.parse(event.detail.xhr.responseText);
      // 如果登录成功
      if (result.success) {
        // 将 access_token 和 refresh_token 存储到本地存储中
        localStorage.setItem('access_token', result.access_token);
        localStorage.setItem('refresh_token', result.refresh_token)
        // 重定向到首页
        window.location.href = '/';
      } else {
        // 如果登录失败，显示错误信息
        showToast(result.message);
      }
    }
    // 处理发送验证码响应的函数
    function handleSendCodeResponse(event) {
      // 解析 AJAX 请求的响应内容
      const result = JSON.parse(event.detail.xhr.responseText);
      // 显示响应信息
      showToast(result.message);
    }
    // jQuery 文档就绪函数
    $(function () {
      // 为登录按钮绑定事件，当 AJAX 请求完成后调用 handleLoginResponse 函数
      $('#passwordLoginButton').on('htmx:afterRequest', handleLoginResponse);
    });
  </script>
</body>

</html>
