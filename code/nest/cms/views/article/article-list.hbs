<h1>
  文章列表
</h1>
<a href="/admin/articles/create" class="btn btn-success mb-3">添加文章</a>
<button id="exportPptBtn" class="btn btn-warning btn-sm mb-3">导出PPT</button>
<button id="frontExportBtn" class="btn btn-info btn-sm mb-3">前台导出Excel</button>
<button id="backendExportBtn" class="btn btn-info btn-sm mb-3">后台导出Excel</button>
<form method="GET" action="/admin/articles" class="mb-3">
  <div class="input-group">
    <input type="text" name="keyword" class="form-control" placeholder="请输入搜索关键字" value="{{keyword}}">
    <button class="btn btn-outline-secondary">搜索</button>
  </div>
</form>
<table class="table" id="articleTable">
  <thead>
    <tr>
      <th>标题</th>
      <th>分类</th>
      <th>标签</th>
      <th>文章状态</th>
      <th>状态</th>
      <th>排序</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {{#each articles}}
    <tr>
      <td>{{this.title}}</td>
      <td>
        {{#each this.categories}}
        <span class="badge bg-secondary">{{this.name}}</span>
        {{/each}}
      </td>
      <td>
        {{#each this.tags}}
        <span class="badge bg-info text-dark">{{this.name}}</span>
        {{/each}}
      </td>
      <td>
        {{#if (eq this.state 'draft')}}
        <span class="badge bg-secondary">草稿</span>
        {{/if}}

        {{#if (eq this.state 'pending')}}
        <span class="badge bg-warning text-dark">待审核</span>
        {{/if}}

        {{#if (eq this.state 'published')}}
        <span class="badge bg-success">已发布</span>
        {{/if}}

        {{#if (eq this.state 'rejected')}}
        <span class="badge bg-danger">审核不通过</span>
        {{/if}}

        {{#if (eq this.state 'withdrawn')}}
        <span class="badge bg-dark">已撤回</span>
        {{/if}}
      </td>
      <td>
        <span class="status-toggle" data-id="{{this.id}}" data-status="{{this.status}}">
          {{#if this.status}}
          <i class="bi bi-check-circle-fill text-success"></i>
          {{else}}
          <i class="bi bi-x-circle-fill text-danger"></i>
          {{/if}}
        </span>
      </td>
      <td>
        <span class="sort-text" data-id="{{this.id}}">{{this.sort}}</span>
        <input type="number" class="form-control sort-input d-none" style="width:50%" data-id="{{this.id}}"
          value="{{this.sort}}">
      </td>
      <td>
        <a href="/admin/articles/{{this.id}}" class="btn btn-primary btn-sm">查看</a>
        <a href="/admin/articles/{{this.id}}/edit" class="btn btn-warning btn-sm">修改</a>
        <a class="btn btn-danger btn-sm" onclick="deleteArticle({{this.id}})">删除</a>
        {{#if (eq this.state 'draft')}}
        <button class="btn btn-warning btn-sm" onclick="submitForReview({{this.id}})">提交审核</button>
        {{/if}}
        {{#if (eq this.state 'pending')}}
        <button class="btn btn-success btn-sm" onclick="approveArticle({{this.id}})">审核通过</button>
        <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
          data-bs-target="#rejectModal-{{this.id}}">审核不通过</button>
        <div class="modal fade" id="rejectModal-{{this.id}}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">审核不通过</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="rejectionReason-{{this.id}}" class="form-label">不通过原因</label>
                  <textarea class="form-control" id="rejectionReason-{{this.id}}" name="rejectionReason"
                    rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="rejectArticle({{this.id}})">提交</button>
              </div>
            </div>
          </div>
        </div>
        {{/if}}
        {{#if (eq this.state 'published')}}
        <button class="btn btn-secondary btn-sm" onclick="withdrawArticle({{this.id}})">撤回</button>
        {{/if}}
      </td>
    </tr>
    {{/each}}
  </tbody>
</table>
<nav>
  <ul class="pagination">
    <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
      <a class="page-link" href="?page={{dec page}}&keyword={{keyword}}&limit={{limit}}">上一页</a>
    </li>
    {{#each (range 1 pageCount)}}
    <li class="page-item {{#if (eq this ../page)}}active{{/if}}">
      <a class="page-link" href="?page={{this}}&keyword={{../keyword}}&limit={{../limit}}">{{this}}</a>
    </li>
    {{/each}}

    <li class="page-item {{#if (eq page pageCount)}}disabled{{/if}}">
      <a class="page-link" href="?page={{inc page}}&keyword={{keyword}}&limit={{limit}}">下一页</a>
    </li>
    <li class="page-item">
      <form method="GET" action="/admin/articles" class="d-inline-block ms-3">
        <input type="hidden" name="keyword" value="{{keyword}}">
        <input type="hidden" name="page" value="{{page}}">
        <div class="input-group">
          <input type="number" name="limit" class="form-control" placeholder="每页条数" value="{{limit}}" min="1">
          <button class="btn btn-outline-secondary" type="submit">设置每页的条数</button>
        </div>
      </form>
    </li>
  </ul>
</nav>
<script>
  function submitForReview(id) {
    if (confirm('确定要提交审核吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/submit`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('提交审核成功');
            location.reload();
          }
        },
        error: function (error) {
          alert('提交审核失败');
        }
      });
    }
  }

  function approveArticle(id) {
    if (confirm('确定要通过审核吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/approve`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('审核通过');
            location.reload();
          }
        },
        error: function (error) {
          alert('审核通过失败');
        }
      });
    }
  }

  function rejectArticle(id) {
    const rejectionReason = $(`#rejectionReason-${id}`).val();
    if (rejectionReason.trim() === '') {
      alert('请填写审核不通过的原因');
      return;
    }
    $.ajax({
      url: `/admin/articles/${id}/reject`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify({ rejectionReason }),
      success: function (data) {
        if (data.success) {
          alert('审核不通过');
          location.reload();
        }
      },
      error: function (error) {
        alert('审核不通过失败');
      }
    });
  }
  function withdrawArticle(id) {
    if (confirm('确定要撤回这篇文章吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/withdraw`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('文章已撤回');
            location.reload();
          }
        },
        error: function (error) {
          alert('撤回文章失败');
        }
      });
    }
  }
  function deleteArticle(id) {
    if (confirm('确定要删除吗?')) {
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'DELETE',
        success: function (data) {
          if (data.success) {
            const params = new URLSearchParams(window.location.search);
            params.delete('page');
            params.append('page', 1)
            const query = params.toString();
            window.location = window.location.pathname + '?' + query;
          }
        }
      })
    }
  }
  $(function () {
    // 当用户点击 ID 为 backendExportBtn 的按钮时，触发事件处理函数
    $('#backendExportBtn').click(function () {
      // 将浏览器的窗口位置重定向到指定的导出 Excel 文件的 URL
      // URL 中包含当前页面、搜索条件和限制参数
      window.location.href = `/admin/articles/export-excel?page={{page}}&search={{search}}&limit={{limit}}`;
    });
    // 当用户点击 ID 为 frontExportBtn 的按钮时，触发事件处理函数
    $('#frontExportBtn').click(function () {
      // 初始化一个空的字符串，用于存储 CSV 文件内容
      let csvContent = '';
      // 遍历表格的表头行（thead 中的所有 tr），生成 CSV 文件的表头内容
      $('#articleTable thead tr').each(function () {
        let rowContent = ''; // 初始化空字符串，用于存储当前行的内容
        let cells = $(this).find('th'); // 获取当前行中的所有 th 单元格
        cells.each(function (index) {
          if (index < cells.length - 1) { // 遍历时排除最后一列（假设不需要导出）
            rowContent += $(this).text().trim() + ','; // 将单元格文本内容加入行内容，并用逗号分隔
          }
        });
        csvContent += rowContent.slice(0, -1) + '\n'; // 移除最后一个多余的逗号并添加换行符
      });
      // 遍历表格的主体行（tbody 中的所有 tr），生成 CSV 文件的表格内容
      $('#articleTable tbody tr').each(function () {
        let rowContent = ''; // 初始化空字符串，用于存储当前行的内容
        let cells = $(this).find('td'); // 获取当前行中的所有 td 单元格
        cells.each(function (index) {
          if (index < cells.length - 1) { // 遍历时排除最后一列（假设不需要导出）
            rowContent += $(this).text().trim().replace(/,/g, '') + ','; // 将单元格文本内容加入行内容，并用逗号分隔，替换掉内容中的逗号以避免干扰 CSV 格式
          }
        });
        csvContent += rowContent.slice(0, -1) + '\n'; // 移除最后一个多余的逗号并添加换行符
      });
      // 创建一个 Blob 对象，包含生成的 CSV 内容，类型为 text/csv，并设置字符编码为 UTF-8
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      // 创建一个指向 Blob 对象的 URL
      let url = URL.createObjectURL(blob);
      // 创建一个隐藏的 <a> 元素，并设置其 href 属性为 Blob URL，设置下载文件名为 articles.csv
      let link = $('<a>').attr({
        href: url,
        download: 'articles.csv'
      }).appendTo('body'); // 将链接元素临时添加到文档的 body 中
      // 模拟点击 <a> 元素以触发下载
      link[0].click();
      // 移除临时添加的 <a> 元素
      link.remove();
    });
    $('#exportPptBtn').click(function () {
      window.location.href = `/admin/articles/export-ppt?page={{page}}&keyword={{keyword}}&limit={{limit}}`;
    });
    $('.sort-text').on('dblclick', function () {
      const $this = $(this);
      const id = $this.data('id');
      $this.addClass('d-none');
      $(`.sort-input[data-id="${id}"]`).removeClass('d-none').focus();
    });
    $('.sort-input').on('blur', function () {
      const $this = $(this);
      const id = $this.data('id');
      const newSort = $this.val();
      $this.addClass('d-none');
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ sort: newSort }),
        success: function (data) {
          if (data.success) {
            $(`.sort-text[data-id="${id}"]`).removeClass('d-none').text(newSort);
          }
        }
      })
    });
    $('.status-toggle').on('click', function () {
      const $this = $(this);
      const id = $this.data('id');
      const currentStatus = $this.data('status');
      const newStatus = currentStatus == 1 ? 0 : 1;
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function (data) {
          if (data.success) {
            $this.data('status', newStatus);
            $this.html(` <i class="bi ${newStatus ? 'bi-check-circle-fill' : 'bi-x-circle-fill'} ${newStatus ? 'text-success' : 'text-danger'}"></i>`);
          }
        }
      })
    });
  });
</script>
