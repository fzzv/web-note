# è£…é¥°å™¨ï¼ˆDecoratorï¼‰

## reflect-metadata

### åŸºæœ¬æ¦‚å¿µ

reflect-metadata æ˜¯å®ç°å…ƒç¼–ç¨‹çš„åº“ï¼Œæä¾›å…ƒæ•°æ®åå°„APIï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ£€æŸ¥å’Œæ“ä½œå¯¹è±¡çš„å…ƒæ•°æ®ã€‚

å…ƒæ•°æ®ï¼ˆMetadataï¼‰æ˜¯æè¿°æ•°æ®çš„æ•°æ®ï¼Œåœ¨ TypeScript ä¸­ï¼Œå…ƒæ•°æ®å¯ä»¥é™„åŠ åˆ°ç±»ã€æ–¹æ³•ã€å±æ€§ç­‰ä¸Šï¼Œç”¨äºåœ¨è¿è¡Œæ—¶è·å–ç±»å‹ä¿¡æ¯ã€é…ç½®ä¿¡æ¯ç­‰ã€‚

### å®‰è£…å’Œå¯¼å…¥

```bash
npm install reflect-metadata
```

```typescript
import 'reflect-metadata'
```

### ä¸»è¦ API

#### 1. å®šä¹‰å…ƒæ•°æ®

**è£…é¥°å™¨æ–¹å¼ - @Reflect.metadata**
```typescript
class PersonClass {
  @Reflect.metadata('methodName', 'methodValue')
  method() {
    console.log('method');
  }
}
```

**ç›´æ¥å®šä¹‰ - Reflect.defineMetadata**
```typescript
const person = new PersonClass('property');
// è¯­æ³•ï¼šReflect.defineMetadata(metadataKey, metadataValue, target, propertyKey?)
Reflect.defineMetadata('name', 'fan', person, 'property');
```

> ğŸ’¡ `@Reflect.metadata` æ˜¯ `Reflect.defineMetadata` çš„è¯­æ³•ç³–ï¼Œç”¨äºç®€åŒ–å…ƒæ•°æ®å®šä¹‰è¿‡ç¨‹ã€‚

#### 2. æ£€æŸ¥å…ƒæ•°æ®

**åˆ¤æ–­æ˜¯å¦å­˜åœ¨å…ƒæ•°æ®**
```typescript
// è¯­æ³•ï¼šReflect.hasMetadata(metadataKey, target, propertyKey?)
const hasMetadata = Reflect.hasMetadata('name', person, 'property');
console.log('åˆ¤æ–­æ˜¯å¦æœ‰å…ƒæ•°æ®:', hasMetadata); // true
```

#### 3. è·å–å…ƒæ•°æ®

**è·å–å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰**
```typescript
// è¯­æ³•ï¼šReflect.getMetadata(metadataKey, target, propertyKey?)
const metadata = Reflect.getMetadata('name', person, 'property');
console.log('è·å–å…ƒæ•°æ®:', metadata); // 'fan'
```

**è·å–è‡ªæœ‰å…ƒæ•°æ®ï¼ˆä¸åŒ…æ‹¬ç»§æ‰¿çš„ï¼‰**
```typescript
// è¯­æ³•ï¼šReflect.getOwnMetadata(metadataKey, target, propertyKey?)
const ownMetadata = Reflect.getOwnMetadata('name', person, 'property');
console.log('è·å–è‡ªæœ‰å…ƒæ•°æ®:', ownMetadata); // 'fan'

// è·å–æ–¹æ³•ä¸Šçš„å…ƒæ•°æ®éœ€è¦é€šè¿‡åŸå‹
const methodMetadata = Reflect.getOwnMetadata('methodName', PersonClass.prototype, 'method');
console.log('æ–¹æ³•å…ƒæ•°æ®:', methodMetadata); // 'methodValue'
```

#### 4. åˆ é™¤å…ƒæ•°æ®

```typescript
// è¯­æ³•ï¼šReflect.deleteMetadata(metadataKey, target, propertyKey?)
Reflect.deleteMetadata('name', person, 'property');
const hasMetadataAfterDelete = Reflect.hasMetadata('name', person, 'property');
console.log('åˆ é™¤åæ˜¯å¦å­˜åœ¨:', hasMetadataAfterDelete); // false
```

### å…¶ä»–å¸¸ç”¨ API

#### è·å–å…ƒæ•°æ®é”®åˆ—è¡¨
```typescript
// è·å–æ‰€æœ‰å…ƒæ•°æ®é”®ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
const metadataKeys = Reflect.getMetadataKeys(target, propertyKey);

// è·å–è‡ªæœ‰å…ƒæ•°æ®é”®ï¼ˆä¸åŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
const ownMetadataKeys = Reflect.getOwnMetadataKeys(target, propertyKey);
```

#### è·å–æ‰€æœ‰å…ƒæ•°æ®
```typescript
// è·å–æ‰€æœ‰å…ƒæ•°æ®é”®å€¼å¯¹
const allMetadata = Reflect.getOwnMetadata(Symbol.for('custom:annotations'), target);
```

### å®é™…åº”ç”¨åœºæ™¯

#### 1. ä¾èµ–æ³¨å…¥
```typescript
@Injectable()
class UserService {
  constructor(
    @Inject('DATABASE') private db: Database
  ) {}
}
```

#### 2. è·¯ç”±è£…é¥°å™¨
```typescript
@Controller('/users')
class UserController {
  @Get('/:id')
  @UseGuards(AuthGuard)
  getUserById(@Param('id') id: string) {
    // ...
  }
}
```

#### 3. éªŒè¯è£…é¥°å™¨
```typescript
class CreateUserDto {
  @IsString()
  @Length(2, 20)
  name: string;

  @IsEmail()
  email: string;
}
```

### æ³¨æ„äº‹é¡¹

1. **target å‚æ•°**ï¼š
   - å¯¹äºå®ä¾‹å±æ€§ï¼šä½¿ç”¨å®ä¾‹å¯¹è±¡
   - å¯¹äºé™æ€å±æ€§ï¼šä½¿ç”¨ç±»æ„é€ å‡½æ•°
   - å¯¹äºæ–¹æ³•ï¼šä½¿ç”¨ç±»çš„åŸå‹ `Class.prototype`

2. **ç»§æ‰¿å…³ç³»**ï¼š
   - `getMetadata` ä¼šæŸ¥æ‰¾ç»§æ‰¿é“¾ä¸Šçš„å…ƒæ•°æ®
   - `getOwnMetadata` åªæŸ¥æ‰¾å¯¹è±¡è‡ªèº«çš„å…ƒæ•°æ®

3. **æ€§èƒ½è€ƒè™‘**ï¼šå…ƒæ•°æ®æ“ä½œæœ‰ä¸€å®šæ€§èƒ½å¼€é”€ï¼Œé¿å…åœ¨çƒ­ç‚¹ä»£ç ä¸­é¢‘ç¹ä½¿ç”¨

### åœ¨ NestJS ä¸­çš„åº”ç”¨

NestJS å¤§é‡ä½¿ç”¨ reflect-metadata æ¥å®ç°ï¼š
- è£…é¥°å™¨å…ƒæ•°æ®å­˜å‚¨
- ä¾èµ–æ³¨å…¥å®¹å™¨
- è·¯ç”±å…ƒæ•°æ®ç®¡ç†
- ç®¡é“ã€å®ˆå«ã€æ‹¦æˆªå™¨çš„å…ƒæ•°æ®

## ç±»è£…é¥°å™¨

ç±»è£…é¥°å™¨æ˜¯åº”ç”¨äºç±»æ„é€ å‡½æ•°çš„ç‰¹æ®Šå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥ç›‘è§†ã€ä¿®æ”¹æˆ–æ›¿æ¢ç±»çš„å®šä¹‰ã€‚ç±»è£…é¥°å™¨åœ¨ç±»å£°æ˜ä¹‹å‰è¢«å£°æ˜ï¼Œç´§æŒ¨ç€ç±»å£°æ˜ã€‚

### åŸºæœ¬è¯­æ³•

ç±»è£…é¥°å™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼šç±»çš„æ„é€ å‡½æ•°ã€‚

```typescript
function logClass(constructor: Function) {
  console.log(`Class Created`, constructor.name);
}

@logClass
class HttpClient {
  constructor() {
    console.log('HttpClient constructor');
  }
}

new HttpClient();
// è¾“å‡ºï¼š
// Class Created HttpClient
// HttpClient constructor
```

### è£…é¥°å™¨å·¥å‚

è£…é¥°å™¨å·¥å‚æ˜¯è¿”å›è£…é¥°å™¨å‡½æ•°çš„é«˜é˜¶å‡½æ•°ï¼Œå¯ä»¥æ¥æ”¶å‚æ•°æ¥æ§åˆ¶è£…é¥°å™¨çš„è¡Œä¸ºã€‚

```typescript
function logClassWithParams(params: string) {
  return function (constructor: Function) {
    console.log(`Class Created`, constructor.name, params);
  }
}

@logClassWithParams('https://www.xyu.fan')
class HttpClient2 {
  constructor() {
    console.log('HttpClient2 constructor');
  }
}

new HttpClient2();
// è¾“å‡ºï¼š
// Class Created HttpClient2 https://www.xyu.fan
// HttpClient2 constructor
```

### æ‰©å±•ç±»åŠŸèƒ½

ç±»è£…é¥°å™¨å¯ä»¥å‘ç±»çš„åŸå‹æ·»åŠ æ–°çš„å±æ€§å’Œæ–¹æ³•ã€‚

```typescript
function addProperty(target: any) {
  target.prototype.url = 'https://www.xyu.fan';
}

// ä½¿ç”¨æ¥å£å£°æ˜åˆå¹¶æ¥æä¾›ç±»å‹æ”¯æŒ
interface HttpClient3 {
  url: string;
}

@addProperty
class HttpClient3 {
  constructor() {
    console.log('HttpClient3 constructor');
  }
}

const httpClient3 = new HttpClient3();
console.log(httpClient3.url); // è¾“å‡ºï¼šhttps://www.xyu.fan
```

### é‡å†™ç±»æ„é€ å‡½æ•°

ç±»è£…é¥°å™¨å¯ä»¥è¿”å›ä¸€ä¸ªæ–°çš„æ„é€ å‡½æ•°æ¥æ›¿æ¢åŸæœ‰çš„æ„é€ å‡½æ•°ã€‚

```typescript
function rewriteClass<T extends { new (...args: any[]): {} }>(constructor: T) {
  return class extends constructor {
    constructor(...args: any[]) {
      super(...args);
      console.log('rewriteClass constructor');
    }
  }
}

@rewriteClass
class HttpClient4 {
  constructor() {
    console.log('HttpClient4 constructor');
  }
}

new HttpClient4();
// è¾“å‡ºï¼š
// HttpClient4 constructor
// rewriteClass constructor
```

### é«˜çº§ç”¨æ³•ç¤ºä¾‹

#### 1. å•ä¾‹æ¨¡å¼è£…é¥°å™¨
```typescript
function Singleton<T extends { new (...args: any[]): {} }>(constructor: T) {
  let instance: T;
  return class extends constructor {
    constructor(...args: any[]) {
      if (instance) {
        return instance;
      }
      super(...args);
      instance = this as any;
      return instance;
    }
  } as T;
}

@Singleton
class DatabaseConnection {
  constructor(public connectionString: string) {}
}
```

#### 2. æ—¥å¿—è£…é¥°å™¨
```typescript
function Logger(logLevel: 'info' | 'debug' | 'error' = 'info') {
  return function <T extends { new (...args: any[]): {} }>(constructor: T) {
    return class extends constructor {
      constructor(...args: any[]) {
        console.log(`[${logLevel.toUpperCase()}] Creating instance of ${constructor.name}`);
        super(...args);
        console.log(`[${logLevel.toUpperCase()}] Instance of ${constructor.name} created`);
      }
    };
  };
}

@Logger('debug')
class ApiService {
  constructor(private baseUrl: string) {}
}
```

#### 3. éªŒè¯è£…é¥°å™¨
```typescript
function ValidateConstructor(validationRules: Record<string, (value: any) => boolean>) {
  return function <T extends { new (...args: any[]): {} }>(constructor: T) {
    return class extends constructor {
      constructor(...args: any[]) {
        // éªŒè¯æ„é€ å‡½æ•°å‚æ•°
        Object.keys(validationRules).forEach((key, index) => {
          const validator = validationRules[key];
          if (!validator(args[index])) {
            throw new Error(`Validation failed for parameter ${key}`);
          }
        });
        super(...args);
      }
    };
  };
}

@ValidateConstructor({
  email: (value: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
  age: (value: number) => value > 0 && value < 150
})
class User {
  constructor(public email: string, public age: number) {}
}
```

### å¤šä¸ªè£…é¥°å™¨çš„æ‰§è¡Œé¡ºåº

å½“å¤šä¸ªè£…é¥°å™¨åº”ç”¨äºåŒä¸€ä¸ªç±»æ—¶ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ä»ä¸‹åˆ°ä¸Šï¼ˆæœ€æ¥è¿‘ç±»å£°æ˜çš„å…ˆæ‰§è¡Œï¼‰ã€‚

```typescript
function first() {
  console.log("first(): factory evaluated");
  return function (target: any) {
    console.log("first(): called");
  };
}

function second() {
  console.log("second(): factory evaluated");
  return function (target: any) {
    console.log("second(): called");
  };
}

@first()
@second()
class ExampleClass {}

// è¾“å‡ºï¼š
// first(): factory evaluated
// second(): factory evaluated
// second(): called
// first(): called
```

## æ–¹æ³•è£…é¥°å™¨

æ–¹æ³•è£…é¥°å™¨æ˜¯åº”ç”¨äºæ–¹æ³•çš„è£…é¥°å™¨ï¼Œå¯ä»¥ç”¨æ¥ç›‘è§†ã€ä¿®æ”¹æˆ–æ›¿æ¢æ–¹æ³•çš„å®šä¹‰ã€‚æ–¹æ³•è£…é¥°å™¨åœ¨æ–¹æ³•å£°æ˜ä¹‹å‰è¢«å£°æ˜ã€‚

### åŸºæœ¬è¯­æ³•

æ–¹æ³•è£…é¥°å™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š

- `target`ï¼šç±»çš„åŸå‹å¯¹è±¡ï¼ˆå¯¹äºé™æ€æ–¹æ³•æ˜¯ç±»çš„æ„é€ å‡½æ•°ï¼‰
- `propertyKey`ï¼šæ–¹æ³•çš„åç§°
- `descriptor`ï¼šæ–¹æ³•çš„å±æ€§æè¿°ç¬¦

```typescript
function logMethod(target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
  const originalMethod = descriptor.value;
  descriptor.value = function (...args: any[]) {
    console.log(`Method ${propertyKey} called with arguments:`, args);
    const result = originalMethod.apply(this, args);
    console.log(`Method ${propertyKey} returned:`, result);
    return result;
  }
}

class Calculator {
  @logMethod
  add(a: number, b: number) {
    return a + b;
  }
}

const calculator = new Calculator();
calculator.add(1, 2);
// è¾“å‡ºï¼š
// Method add called with arguments: [1, 2]
// Method add returned: 3
```

### æƒé™æ§åˆ¶è£…é¥°å™¨

æ–¹æ³•è£…é¥°å™¨å¯ä»¥ç”¨æ¥å®ç°æƒé™æ£€æŸ¥ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œæƒé™éªŒè¯ã€‚

```typescript
function checkPermission(target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
  const originalMethod = descriptor.value;
  descriptor.value = function (...args: any[]) {
    if (user[args[0]].role.includes('admin')) {
      return originalMethod.apply(this, args);
    } else {
      throw new Error('Permission denied');
    }
  }
  return descriptor;
}

const user = {
  'user1': { role: ['admin', 'user'] },
  'user2': { role: ['user'] },
}

class WebSite {
  @checkPermission
  deleteUser(userId: string) {
    console.log(`delete user ${userId}`);
  }
}

const webSite = new WebSite();
webSite.deleteUser('user1'); // æˆåŠŸæ‰§è¡Œ
// webSite.deleteUser('user2'); // æŠ›å‡º Permission denied é”™è¯¯
```

### ç¼“å­˜è£…é¥°å™¨

æ–¹æ³•è£…é¥°å™¨å¯ä»¥å®ç°æ–¹æ³•ç»“æœçš„ç¼“å­˜ï¼Œæé«˜æ€§èƒ½ã€‚

```typescript
function cacheMethod(target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
  const originalMethod = descriptor.value;
  const cache = new Map();
  descriptor.value = function (...args: any[]) {
    const key = JSON.stringify(args);
    if (cache.has(key)) {
      console.log(`Cache hit for ${key}`);
      return cache.get(key);
    }
    const result = originalMethod.apply(this, args);
    console.log(`Cache ${key} = ${result}`);
    cache.set(key, result);
    return result;
  }
  return descriptor;
}

class CacheCalculator {
  @cacheMethod
  add(a: number, b: number) {
    return a + b;
  }
}

const cacheCalculator = new CacheCalculator();
cacheCalculator.add(1, 2); // é¦–æ¬¡è°ƒç”¨ï¼Œç¼“å­˜ç»“æœ
cacheCalculator.add(1, 2); // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œä»ç¼“å­˜è¿”å›
```

### é«˜çº§ç”¨æ³•ç¤ºä¾‹

#### 1. æ€§èƒ½ç›‘æ§è£…é¥°å™¨
```typescript
function performance(target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
  const originalMethod = descriptor.value;
  descriptor.value = function (...args: any[]) {
    const start = performance.now();
    const result = originalMethod.apply(this, args);
    const end = performance.now();
    console.log(`Method ${propertyKey} executed in ${end - start} milliseconds`);
    return result;
  };
  return descriptor;
}

class DataProcessor {
  @performance
  processLargeData(data: any[]) {
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    return data.map(item => item * 2);
  }
}
```

#### 2. é‡è¯•è£…é¥°å™¨
```typescript
function retry(maxAttempts: number = 3, delay: number = 1000) {
  return function (target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;
    descriptor.value = async function (...args: any[]) {
      let attempts = 0;
      while (attempts < maxAttempts) {
        try {
          return await originalMethod.apply(this, args);
        } catch (error) {
          attempts++;
          if (attempts >= maxAttempts) {
            throw error;
          }
          console.log(`Attempt ${attempts} failed, retrying in ${delay}ms...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    };
    return descriptor;
  };
}

class ApiClient {
  @retry(3, 2000)
  async fetchData(url: string) {
    // æ¨¡æ‹Ÿå¯èƒ½å¤±è´¥çš„ API è°ƒç”¨
    if (Math.random() < 0.7) {
      throw new Error('Network error');
    }
    return { data: 'success' };
  }
}
```

#### 3. å‚æ•°éªŒè¯è£…é¥°å™¨
```typescript
function validateArgs(validators: ((arg: any) => boolean)[]) {
  return function (target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;
    descriptor.value = function (...args: any[]) {
      validators.forEach((validator, index) => {
        if (!validator(args[index])) {
          throw new Error(`Invalid argument at position ${index} for method ${propertyKey}`);
        }
      });
      return originalMethod.apply(this, args);
    };
    return descriptor;
  };
}

class MathOperations {
  @validateArgs([
    (a: number) => typeof a === 'number' && !isNaN(a),
    (b: number) => typeof b === 'number' && !isNaN(b) && b !== 0
  ])
  divide(a: number, b: number) {
    return a / b;
  }
}
```

#### 4. å¼‚æ­¥é”™è¯¯å¤„ç†è£…é¥°å™¨
```typescript
function asyncErrorHandler(target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
  const originalMethod = descriptor.value;
  descriptor.value = async function (...args: any[]) {
    try {
      return await originalMethod.apply(this, args);
    } catch (error) {
      console.error(`Error in method ${propertyKey}:`, error);
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯ä¸ŠæŠ¥ã€æ—¥å¿—è®°å½•ç­‰é€»è¾‘
      throw error;
    }
  };
  return descriptor;
}

class UserService {
  @asyncErrorHandler
  async createUser(userData: any) {
    // å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„å¼‚æ­¥æ“ä½œ
    return await database.save(userData);
  }
}
```

### åœ¨ NestJS ä¸­çš„åº”ç”¨

#### 1. HTTP æ–¹æ³•è£…é¥°å™¨
```typescript
@Controller('users')
export class UsersController {
  @Get(':id')
  findOne(@Param('id') id: string) {
    return `This action returns user #${id}`;
  }

  @Post()
  @HttpCode(201)
  create(@Body() createUserDto: CreateUserDto) {
    return 'This action adds a new user';
  }

  @Put(':id')
  update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
    return `This action updates user #${id}`;
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return `This action removes user #${id}`;
  }
}
```

#### 2. å®ˆå«è£…é¥°å™¨
```typescript
@Controller('admin')
export class AdminController {
  @Get('users')
  @UseGuards(AuthGuard, RolesGuard)
  @Roles('admin')
  getAllUsers() {
    return 'Admin only endpoint';
  }
}
```

#### 3. æ‹¦æˆªå™¨è£…é¥°å™¨
```typescript
@Controller('data')
export class DataController {
  @Get()
  @UseInterceptors(LoggingInterceptor, TransformInterceptor)
  @Timeout(5000)
  getData() {
    return { message: 'Hello World' };
  }
}
```

#### 4. ç®¡é“è£…é¥°å™¨
```typescript
@Controller('validation')
export class ValidationController {
  @Post()
  create(
    @Body(ValidationPipe) createDto: CreateUserDto,
    @Query('type', ParseIntPipe) type: number
  ) {
    return 'Data validated and processed';
  }
}
```

### PropertyDescriptor è¯¦è§£

æ–¹æ³•è£…é¥°å™¨ä¸­çš„ `descriptor` å‚æ•°åŒ…å«ä»¥ä¸‹å±æ€§ï¼š

```typescript
interface PropertyDescriptor {
  value?: any;           // æ–¹æ³•çš„å®ç°
  writable?: boolean;    // æ˜¯å¦å¯å†™
  enumerable?: boolean;  // æ˜¯å¦å¯æšä¸¾
  configurable?: boolean; // æ˜¯å¦å¯é…ç½®
  get?(): any;          // getter æ–¹æ³•
  set?(v: any): void;   // setter æ–¹æ³•
}
```

### è£…é¥°å™¨ç»„åˆä½¿ç”¨

å¤šä¸ªæ–¹æ³•è£…é¥°å™¨å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œæ‰§è¡Œé¡ºåºä»ä¸‹åˆ°ä¸Šï¼š

```typescript
class ApiService {
  @asyncErrorHandler
  @performance
  @retry(3)
  @cacheMethod
  async fetchUserData(userId: string) {
    return await this.httpClient.get(`/users/${userId}`);
  }
}
```

### å¸¸è§åº”ç”¨æ¨¡å¼

#### 1. AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰
```typescript
// å‰ç½®é€šçŸ¥
function before(advice: Function) {
  return function (target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;
    descriptor.value = function (...args: any[]) {
      advice.apply(this, args);
      return originalMethod.apply(this, args);
    };
  };
}

// åç½®é€šçŸ¥
function after(advice: Function) {
  return function (target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;
    descriptor.value = function (...args: any[]) {
      const result = originalMethod.apply(this, args);
      advice.call(this, result);
      return result;
    };
  };
}
```

#### 2. æ–¹æ³•é™æµè£…é¥°å™¨
```typescript
function throttle(limit: number, window: number) {
  const calls = new Map();
  return function (target: Object, propertyKey: string | Symbol, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;
    descriptor.value = function (...args: any[]) {
      const now = Date.now();
      const key = `${target.constructor.name}.${propertyKey}`;
      
      if (!calls.has(key)) {
        calls.set(key, []);
      }
      
      const callTimes = calls.get(key);
      const recentCalls = callTimes.filter((time: number) => now - time < window);
      
      if (recentCalls.length >= limit) {
        throw new Error(`Method ${propertyKey} called too frequently`);
      }
      
      recentCalls.push(now);
      calls.set(key, recentCalls);
      
      return originalMethod.apply(this, args);
    };
  };
}
```

## è®¿é—®å™¨è£…é¥°å™¨å’Œå±æ€§è£…é¥°å™¨

### è®¿é—®å™¨è£…é¥°å™¨

è®¿é—®å™¨è£…é¥°å™¨ç”¨æ¥è£…é¥°ç±»çš„ getter å’Œ setter æ–¹æ³•ï¼Œå¯ä»¥ç›‘è§†ã€ä¿®æ”¹æˆ–æ›¿æ¢è®¿é—®å™¨çš„å®šä¹‰ã€‚

#### åŸºæœ¬è¯­æ³•

è®¿é—®å™¨è£…é¥°å™¨æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š
- `target`ï¼šç±»çš„åŸå‹å¯¹è±¡ï¼ˆé™æ€æˆå‘˜ä¸ºç±»çš„æ„é€ å‡½æ•°ï¼‰
- `propertyKey`ï¼šå±æ€§çš„åç§°
- `descriptor`ï¼šå±æ€§æè¿°ç¬¦

```typescript
function LogAccessor(
  target: any,
  propertyKey: string,
  descriptor: PropertyDescriptor
) {
  const originalGet = descriptor.get;
  descriptor.get = function () {
    console.log(`Accessed property: ${propertyKey}`);
    return originalGet?.call(this);
  };
}

class User {
  private _name = 'Alice';

  @LogAccessor
  get name() {
    return this._name;
  }
}

const u = new User();
console.log(u.name); 
// è¾“å‡ºï¼š
// Accessed property: name
// Alice
```

#### é«˜çº§è®¿é—®å™¨è£…é¥°å™¨ç¤ºä¾‹

**1. è¯»å†™ç›‘æ§è£…é¥°å™¨**
```typescript
function Monitor(target: any, propertyKey: string, descriptor: PropertyDescriptor) {
  const originalGet = descriptor.get;
  const originalSet = descriptor.set;
  
  if (originalGet) {
    descriptor.get = function () {
      console.log(`Reading ${propertyKey}`);
      const value = originalGet.call(this);
      console.log(`Read ${propertyKey}: ${value}`);
      return value;
    };
  }
  
  if (originalSet) {
    descriptor.set = function (value: any) {
      console.log(`Writing ${propertyKey}: ${value}`);
      return originalSet.call(this, value);
    };
  }
}

class Product {
  private _price: number = 0;

  @Monitor
  get price() {
    return this._price;
  }

  set price(value: number) {
    this._price = value;
  }
}
```

**2. æ•°æ®éªŒè¯è£…é¥°å™¨**
```typescript
function ValidateRange(min: number, max: number) {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const originalSet = descriptor.set;
    descriptor.set = function (value: number) {
      if (value < min || value > max) {
        throw new Error(`${propertyKey} must be between ${min} and ${max}`);
      }
      return originalSet?.call(this, value);
    };
  };
}

class Temperature {
  private _celsius: number = 0;

  @ValidateRange(-273.15, 1000)
  get celsius() {
    return this._celsius;
  }

  set celsius(value: number) {
    this._celsius = value;
  }
}
```

### å±æ€§è£…é¥°å™¨

å±æ€§è£…é¥°å™¨ç”¨æ¥è£…é¥°ç±»çš„å±æ€§ï¼Œé€šå¸¸ä¸ reflect-metadata ç»“åˆä½¿ç”¨æ¥å­˜å‚¨å…ƒæ•°æ®ã€‚

#### åŸºæœ¬è¯­æ³•

å±æ€§è£…é¥°å™¨æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š
- `target`ï¼šç±»çš„åŸå‹å¯¹è±¡ï¼ˆé™æ€å±æ€§ä¸ºç±»çš„æ„é€ å‡½æ•°ï¼‰
- `propertyKey`ï¼šå±æ€§çš„åç§°

```typescript
import 'reflect-metadata';

function Required(target: any, propertyKey: string) {
  const requiredProps = Reflect.getMetadata('required:props', target) || [];
  Reflect.defineMetadata(
    'required:props',
    [...requiredProps, propertyKey],
    target
  );
}

class User1 {
  @Required
  username: string;

  email: string;
}

function validateRequired(obj: any) {
  const requiredProps = Reflect.getMetadata('required:props', obj) || [];
  for (const key of requiredProps) {
    if (!obj[key]) {
      console.log(`${key} is required`);
    }
  }
}

const u1 = new User1();
u1.username = ''; // æœªèµ‹å€¼
validateRequired(u1); // è¾“å‡ºï¼šusername is required
```

#### é«˜çº§å±æ€§è£…é¥°å™¨ç¤ºä¾‹

**1. ç±»å‹éªŒè¯è£…é¥°å™¨**
```typescript
function Type(type: 'string' | 'number' | 'boolean' | 'object') {
  return function (target: any, propertyKey: string) {
    Reflect.defineMetadata('validation:type', type, target, propertyKey);
  };
}

function validate(obj: any) {
  const properties = Object.getOwnPropertyNames(obj);
  for (const prop of properties) {
    const expectedType = Reflect.getMetadata('validation:type', obj, prop);
    if (expectedType && typeof obj[prop] !== expectedType) {
      throw new Error(`Property ${prop} must be of type ${expectedType}`);
    }
  }
}

class UserProfile {
  @Type('string')
  name: string;

  @Type('number')
  age: number;

  @Type('boolean')
  isActive: boolean;
}
```

**2. æ ¼å¼åŒ–è£…é¥°å™¨**
```typescript
function Format(formatter: (value: any) => any) {
  return function (target: any, propertyKey: string) {
    const formatters = Reflect.getMetadata('formatters', target) || new Map();
    formatters.set(propertyKey, formatter);
    Reflect.defineMetadata('formatters', formatters, target);
    
    // é‡æ–°å®šä¹‰å±æ€§
    let value: any;
    Object.defineProperty(target, `_${propertyKey}`, {
      writable: true,
      enumerable: false
    });
    
    Object.defineProperty(target, propertyKey, {
      get() {
        return this[`_${propertyKey}`];
      },
      set(newValue: any) {
        this[`_${propertyKey}`] = formatter(newValue);
      },
      enumerable: true,
      configurable: true
    });
  };
}

class UserInfo {
  @Format((value: string) => value.toLowerCase().trim())
  email: string;

  @Format((value: string) => value.charAt(0).toUpperCase() + value.slice(1).toLowerCase())
  firstName: string;
}

const userInfo = new UserInfo();
userInfo.email = '  JOHN@EXAMPLE.COM  ';
userInfo.firstName = 'jOhN';
console.log(userInfo.email);     // john@example.com
console.log(userInfo.firstName); // John
```

**3. é»˜è®¤å€¼è£…é¥°å™¨**
```typescript
function Default(defaultValue: any) {
  return function (target: any, propertyKey: string) {
    const defaults = Reflect.getMetadata('defaults', target) || new Map();
    defaults.set(propertyKey, defaultValue);
    Reflect.defineMetadata('defaults', defaults, target);
  };
}

function applyDefaults(obj: any) {
  const defaults = Reflect.getMetadata('defaults', obj) || new Map();
  for (const [key, value] of defaults) {
    if (obj[key] === undefined || obj[key] === null) {
      obj[key] = value;
    }
  }
}

class Configuration {
  @Default('localhost')
  host: string;

  @Default(3000)
  port: number;

  @Default(false)
  debug: boolean;
}
```

### è£…é¥°å™¨æ‰§è¡Œé¡ºåº

æ ¹æ®ä»£ç ç¤ºä¾‹ï¼Œä¸åŒç±»å‹è£…é¥°å™¨çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

```typescript
function classDecorator1(target) { console.log('classDecorator1'); }
function classDecorator2(target) { console.log('classDecorator2'); }
function propertyDecorator1(target, propertyKey) { console.log('propertyDecorator1'); }
function propertyDecorator2(target, propertyKey) { console.log('propertyDecorator2'); }
function methodDecorator1(target, propertyKey) { console.log('methodDecorator1'); }
function methodDecorator2(target, propertyKey) { console.log('methodDecorator2'); }
function accessorDecorator1(target, propertyKey) { console.log('accessorDecorator1'); }
function accessorDecorator2(target, propertyKey) { console.log('accessorDecorator2'); }
function parameterDecorator1(target, propertyKey, parameterIndex: number) {
  console.log('parameterDecorator1', propertyKey);
}
function parameterDecorator2(target, propertyKey, parameterIndex: number) {
  console.log('parameterDecorator2', propertyKey);
}

@classDecorator1
@classDecorator2
class Example {
  @accessorDecorator1
  @accessorDecorator2
  get myProp() {
    return this.prop;
  }

  @propertyDecorator1
  @propertyDecorator2
  prop: string;

  @methodDecorator1
  @methodDecorator2
  method(
    @parameterDecorator2 @parameterDecorator1 param1: any,
    @parameterDecorator2 @parameterDecorator1 param2: any
  ) {}
}

// æ‰§è¡Œé¡ºåºï¼š
// 1. è®¿é—®å™¨è£…é¥°å™¨ï¼šaccessorDecorator2 â†’ accessorDecorator1
// 2. å±æ€§è£…é¥°å™¨ï¼špropertyDecorator2 â†’ propertyDecorator1  
// 3. å‚æ•°è£…é¥°å™¨ï¼šä»å³åˆ°å·¦ï¼Œä»ä¸‹åˆ°ä¸Š
// 4. æ–¹æ³•è£…é¥°å™¨ï¼šmethodDecorator2 â†’ methodDecorator1
// 5. ç±»è£…é¥°å™¨ï¼šclassDecorator2 â†’ classDecorator1
```

### æ‰§è¡Œé¡ºåºè§„åˆ™æ€»ç»“

1. **å±æ€§è£…é¥°å™¨ã€æ–¹æ³•è£…é¥°å™¨ã€è®¿é—®å™¨è£…é¥°å™¨**ï¼šæŒ‰ç…§åœ¨ç±»ä¸­å‡ºç°çš„é¡ºåºï¼Œä»ä¸Šå¾€ä¸‹ä¾æ¬¡æ‰§è¡Œ
2. **ç±»è£…é¥°å™¨**ï¼šæœ€åæ‰§è¡Œ
3. **å‚æ•°è£…é¥°å™¨**ï¼šå…ˆäºæ–¹æ³•è£…é¥°å™¨æ‰§è¡Œ
4. **å¤šä¸ªè£…é¥°å™¨**ï¼šä»å³å‘å·¦ï¼Œä»ä¸‹åˆ°ä¸Šæ‰§è¡Œï¼ˆæœ€æ¥è¿‘è¢«è£…é¥°é¡¹çš„å…ˆæ‰§è¡Œï¼‰

### åœ¨ NestJS ä¸­çš„åº”ç”¨

#### 1. å±æ€§è£…é¥°å™¨åº”ç”¨
```typescript
// ä¾èµ–æ³¨å…¥
class UserService {
  @Inject('USER_REPOSITORY')
  private userRepository: UserRepository;

  @InjectRepository(User)
  private userRepo: Repository<User>;
}

// é…ç½®æ³¨å…¥
class AppService {
  @ConfigProperty('database.host')
  private dbHost: string;

  @ConfigProperty('database.port', 5432)
  private dbPort: number;
}
```

#### 2. è®¿é—®å™¨è£…é¥°å™¨åº”ç”¨
```typescript
// æ•°æ®è½¬æ¢
class UserDto {
  private _email: string;

  @Transform(({ value }) => value.toLowerCase())
  get email() {
    return this._email;
  }

  set email(value: string) {
    this._email = value;
  }
}

// API å±æ€§æ–‡æ¡£
class CreateUserDto {
  private _age: number;

  @ApiProperty({ minimum: 0, maximum: 120 })
  @IsNumber()
  @Min(0)
  @Max(120)
  get age() {
    return this._age;
  }

  set age(value: number) {
    this._age = value;
  }
}
```

### å®ç”¨è£…é¥°å™¨é›†åˆ

#### 1. åªè¯»å±æ€§è£…é¥°å™¨
```typescript
function ReadOnly(target: any, propertyKey: string) {
  Object.defineProperty(target, propertyKey, {
    writable: false,
    configurable: false
  });
}

class Config {
  @ReadOnly
  readonly API_URL = 'https://api.example.com';
}
```

#### 2. å»¶è¿ŸåŠ è½½è£…é¥°å™¨
```typescript
function Lazy(loader: () => any) {
  return function (target: any, propertyKey: string) {
    let loaded = false;
    let value: any;
    
    Object.defineProperty(target, propertyKey, {
      get() {
        if (!loaded) {
          value = loader();
          loaded = true;
        }
        return value;
      },
      enumerable: true,
      configurable: true
    });
  };
}

class DataService {
  @Lazy(() => new ExpensiveResource())
  resource: ExpensiveResource;
}
```

#### 3. è§‚å¯Ÿè€…æ¨¡å¼è£…é¥°å™¨
```typescript
function Observable(target: any, propertyKey: string) {
  const observers = new Set<(value: any) => void>();
  let value: any;
  
  // æ·»åŠ è®¢é˜…æ–¹æ³•
  target[`subscribe${propertyKey.charAt(0).toUpperCase() + propertyKey.slice(1)}`] = 
    function (observer: (value: any) => void) {
      observers.add(observer);
    };
  
  Object.defineProperty(target, propertyKey, {
    get() {
      return value;
    },
    set(newValue: any) {
      const oldValue = value;
      value = newValue;
      observers.forEach(observer => observer({ oldValue, newValue, propertyKey }));
    },
    enumerable: true,
    configurable: true
  });
}

class Model {
  @Observable
  name: string;
}

const model = new Model();
model.subscribeName((change) => {
  console.log(`Property ${change.propertyKey} changed from ${change.oldValue} to ${change.newValue}`);
});
model.name = 'John'; // è§¦å‘è§‚å¯Ÿè€…
```

### å‚æ•°è£…é¥°å™¨

å‚æ•°è£…é¥°å™¨ç”¨æ¥è£…é¥°å‡½æ•°å‚æ•°ï¼Œé€šå¸¸ä¸ reflect-metadata ç»“åˆä½¿ç”¨ã€‚

#### åŸºæœ¬è¯­æ³•

å‚æ•°è£…é¥°å™¨æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š
- `target`ï¼šç±»çš„åŸå‹å¯¹è±¡
- `propertyKey`ï¼šæ–¹æ³•çš„åç§°
- `parameterIndex`ï¼šå‚æ•°åœ¨å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­çš„ç´¢å¼•

```typescript
function LogParam(target: any, propertyKey: string, parameterIndex: number) {
  const existingParams = Reflect.getMetadata('log:params', target, propertyKey) || [];
  existingParams.push(parameterIndex);
  Reflect.defineMetadata('log:params', existingParams, target, propertyKey);
}

function logParams(target: any, propertyKey: string, descriptor: PropertyDescriptor) {
  const originalMethod = descriptor.value;
  const loggedParams = Reflect.getMetadata('log:params', target, propertyKey) || [];
  
  descriptor.value = function (...args: any[]) {
    loggedParams.forEach((index: number) => {
      console.log(`Parameter ${index} in ${propertyKey}:`, args[index]);
    });
    return originalMethod.apply(this, args);
  };
}

class ApiService {
  @logParams
  createUser(@LogParam name: string, @LogParam email: string, age: number) {
    return { name, email, age };
  }
}
```

### è£…é¥°å™¨æ‰§è¡Œé¡ºåºè¯¦è§£

åŸºäºä»£ç ç¤ºä¾‹ï¼Œå®Œæ•´çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

```typescript
@classDecorator1
@classDecorator2
class Example {
  @accessorDecorator1
  @accessorDecorator2
  get myProp() {
    return this.prop;
  }

  @propertyDecorator1
  @propertyDecorator2
  prop: string;

  @methodDecorator1
  @methodDecorator2
  method(
    @parameterDecorator4 @parameterDecorator3 param1: any,
    @parameterDecorator2 @parameterDecorator1 param2: any
  ) {}
}

// å®é™…æ‰§è¡Œé¡ºåºï¼š
// 1. accessorDecorator2
// 2. accessorDecorator1
// 3. propertyDecorator2
// 4. propertyDecorator1
// 5. parameterDecorator3 (param1)
// 6. parameterDecorator4 (param1)
// 7. parameterDecorator1 (param2)
// 8. parameterDecorator2 (param2)
// 9. methodDecorator2
// 10. methodDecorator1
// 11. classDecorator2
// 12. classDecorator1
```

#### æ‰§è¡Œè§„åˆ™æ€»ç»“

1. **åŒç±»å‹å¤šä¸ªè£…é¥°å™¨**ï¼šä»ä¸‹åˆ°ä¸Šæ‰§è¡Œï¼ˆæœ€æ¥è¿‘è¢«è£…é¥°é¡¹çš„å…ˆæ‰§è¡Œï¼‰
2. **ä¸åŒç±»å‹è£…é¥°å™¨**ï¼š
   - è®¿é—®å™¨/å±æ€§/æ–¹æ³•è£…é¥°å™¨ï¼šæŒ‰åœ¨ç±»ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œ
   - å‚æ•°è£…é¥°å™¨ï¼šå…ˆäºå¯¹åº”çš„æ–¹æ³•è£…é¥°å™¨æ‰§è¡Œ
   - ç±»è£…é¥°å™¨ï¼šæœ€åæ‰§è¡Œ
3. **å‚æ•°è£…é¥°å™¨ç‰¹æ®Šè§„åˆ™**ï¼š
   - å¤šä¸ªå‚æ•°ï¼šä»å³å‘å·¦æ‰§è¡Œ
   - å•ä¸ªå‚æ•°å¤šä¸ªè£…é¥°å™¨ï¼šä»å³å‘å·¦æ‰§è¡Œ

